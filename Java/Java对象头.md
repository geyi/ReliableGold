**普通对象**
```
|--------------------------------------------------------------|
|                     Object Header (64 bits)                  |
|------------------------------------|-------------------------|
|        Mark Word (32 bits)         |    Klass Word (32 bits) |
|------------------------------------|-------------------------|
```

在开启指针压缩的情况下（默认开启）Klass Word占用的空间是4个字节，关闭指针压缩（-XX:-UseCompressedOops）后占用8个字节

**数组对象**
```
|---------------------------------------------------------------------------------|
|                                 Object Header (96 bits)                         |
|--------------------------------|-----------------------|------------------------|
|        Mark Word(32bits)       |    Klass Word(32bits) |  array length(32bits)  |
|--------------------------------|-----------------------|------------------------|
```

# 对象头的组成

## Mark Word
这部分主要用来存储对象自身的运行时数据，如：hashcode、对象年龄等，示意如下：
```
|-------------------------------------------------------|--------------------|
|                  Mark Word (32 bits)                  |       State        |
|-------------------------------------------------------|--------------------|
| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|-------------------------------------------------------|--------------------|
|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|-------------------------------------------------------|--------------------|
|               ptr_to_lock_record:30          | lock:2 | Lightweight Locked |
|-------------------------------------------------------|--------------------|
|               ptr_to_heavyweight_monitor:30  | lock:2 | Heavyweight Locked |
|-------------------------------------------------------|--------------------|
|                                              | lock:2 |    Marked for GC   |
|-------------------------------------------------------|--------------------|
```

**lock**：2位的锁状态标记位。  
**biased_lock**：对象是否启用偏向锁标志，只占用1个二进制位。为1时表示对象启动偏向锁，为0时表示对象没有启动偏向锁。  

biased_lock | lock | 状态
:--: | :--: | :--:
0 | 01 | 无锁
1 | 01 | 偏向锁
0 | 00 | 轻量级锁
0 | 10 | 重量级锁
0 | 11 | GC标记

**age**：4位的Java对象年龄。处于新生代中的对象，每经历一次垃圾收集，年龄增加1。当对象达到设定的阈值时，将会晋升到老年代。默认情况下，并行GC的晋升阈值为15，并发GC的晋升阈值为6。因为age由4个二进制位表示，所以取值范围在0 - 15。  
**identity_hashcode**：25位的对象hash码。调用System.identityHashCode方法计算，并会将结果写到该对象头中。当对象被锁定时，该值会移动到管程Monitor中。  
**thread**：持有偏向锁的线程ID。  
**epoch**：偏向时间戳？  
**ptr_to_lock_record**：指向栈中锁记录的指针。  
**ptr_to_heavyweight_monitor**：指向管程Monitor的指针。

Java对象头由两个Word组成，包含的基本信息有堆对象的布局、类型、GC状态、同步状态和哈希码。
- Mark Word包含了锁信息、哈希吗、GC信息。
- Klass Word包含指向另一个对象（元对象）的指针。

这里可以查看[OpenJDK](http://openjdk.java.net/groups/hotspot/docs/HotSpotGlossary.html)官网的描述

64位下的标记字与32位的相似，不再赘述：
```
|------------------------------------------------------------------------------|--------------------|
|                                  Mark Word (64 bits)                         |       State        |
|------------------------------------------------------------------------------|--------------------|
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|------------------------------------------------------------------------------|--------------------|
| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|------------------------------------------------------------------------------|--------------------|
|                       ptr_to_lock_record:62                         | lock:2 | Lightweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                     ptr_to_heavyweight_monitor:62                   | lock:2 | Heavyweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                                                                     | lock:2 |    Marked for GC   |
|------------------------------------------------------------------------------|--------------------|
```

# 锁升级
## 偏向锁
线程A，线程B  
如果一个锁对象是可偏向的（biased_lock：1 && lock：01 && thread：null），线程A则会尝试用CAS操作将自己的线程ID写入Mark Word  
如果写入成功则获得偏向锁（biased_lock：1 && lock：01 && thread：123），执行同步操作。

注：计算对象的哈希值之后，将不能使用偏向锁，锁升级为轻量级锁。

关闭偏向锁延迟：-XX:BiasedLockingStartupDelay=0

## 轻量级锁
轻量级锁尝试在应用层面解决线程同步问题，而不触发操作系统的互斥操作，轻量级锁减少多线程进入互斥的几率，不能代替互斥。  
轻量级锁的加锁解锁过程：加锁前是无锁状态（00000001），加锁后是轻量级锁的状态（01010000），解锁后是无锁的状态（00000001）。

注：调用wait方法轻量级锁会变成重量锁。

## 总结
偏向锁：在没有竞争的情况下，线程A对锁对象首次加锁的时候就是偏向锁。

轻量级锁：
- 线程A对锁对象X加锁，在运行结束并释放锁之后，线程B再对锁对象X加锁，这时的锁是轻量级锁。
- 线程A对锁对象X加锁，并处于运行状态时，线程B也对锁对象X进行加锁，只要两个线程没有竞争，这个时候也是轻量锁。

重量级锁：当线程A和线程B同时对一个锁对象X进行加锁，此时存在资源的竞争，这个时候就是重量级锁。


> 参考：https://www.jianshu.com/p/3d38cba67f8b  
> 参考：https://blog.csdn.net/qq_36434742/article/details/106854061